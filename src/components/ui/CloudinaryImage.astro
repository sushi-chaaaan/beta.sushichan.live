---
import { cloudinaryLoader, getCloudinaryImageSize } from "@/lib/cloudinary"
import Image from "@/components/base/Image.astro"
import { declareLet } from "@/utils/declareLet"

type Props = {
  src: string
  alt?: string
}

const { src, alt } = Astro.props

const rawSize = await getCloudinaryImageSize(src)
const altIsEmpty = alt === "" || alt === undefined

const size = declareLet(() => {
  const MAX_WIDTH = 960
  let w = rawSize.width
  let h = rawSize.height
  if (w > MAX_WIDTH) {
    h *= MAX_WIDTH / w
    w = MAX_WIDTH
  }
  return { width: w, height: h }
})

const optimizedSrc = cloudinaryLoader({
  src,
  width: size.width,
  quality: 75,
})
---

<div class="flex flex-col flex-nowrap">
  <Image
    alt={altIsEmpty ? "" : alt}
    height={size.height}
    src={optimizedSrc}
    width={size.width}
  />
</div>
