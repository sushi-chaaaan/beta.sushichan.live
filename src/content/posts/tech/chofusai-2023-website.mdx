---
title: 第73回調布祭Webサイトを支えた技術
description: 各方面に感謝を込めて
createdAt: 2023-12-01
thumbnail: https://res.cloudinary.com/sushi-chan/image/upload/v1701280464/tech/chofusai-2023-website/IMG_0645_mix7iv_qkbnco.jpg
tags:
  - 雑記
  - 技術
  - Next.js
  - Advent Calendar
status: published
---

<MessageCard type="info">
  この記事は第73回調布祭実行委員会に許可を取って公開しています。
</MessageCard>

この記事は[UEC Advent Calendar 2023](https://adventar.org/calendars/8698)の1日目の記事です。

<UrlCard url="https://adventar.org/calendars/8698" />

こんにちは、 [すし](/about)です。 大学では[調布祭実行委員会](https://twitter.com/chofu_festival)や[バーチャルライブ研究会](https://twitter.com/uec_VL_Lab)で技術面のサポートをしています。

つい先日、2023年11月24日から26日にかけて開催された、電気通信大学の大学祭「第73回調布祭」において、
Webサイト制作という形で運営に参加させていただきました。


自分が担当した分野での振り返りや技術的メリット・デメリットなどを書き残しておきたいので、[^1]
当初の予定トピックを変更してこの記事を書くことにしました。

[^1]:疲れており完全に新しい内容で記事を書く気力がないです。悲しいね。

ということで、カレンダー1日目からマニアックな記事になってしまいますが、よろしくお願いします。

<UrlCard caption="完成した第73回調布祭公式Webサイト" url="https://73rd.chofusai.jp" />

## はじめに

私は主に

- 技術選定・初期実装(後述する内製Markdownライブラリなど)
- メンバーの進捗の統合・修正
- パフォーマンスやアクセシビリティの向上
- デプロイ・インフラの構築

を担当しました。

大変好評だった学内マップや、企画一覧ページの検索機能は主にいーちゃん([@e_chan1007_u](https://twitter.com/e_chan1007_u))がゴリゴリ実装してくれました。
今の私では絶対力が足りません。偉業すぎる。改めて感謝の意を表します。

## 使用した技術とインフラ

主に使用した技術やインフラは以下の通りです。

- [Next.js (App Router, v13)](#nextjsapp-router)
- [Markdown](#markdown)
- [Cloudflare (CDN)](#cloudflare)
- [Vercel (Hosting)](#vercel)

ということで、それを選んだ理由や、メリット・デメリットなどをつらつら書いていきます。

### Next.js(App Router)

実はもともとNext.jsを使うこと自体は決まっていました。

というのも、[2023年度新歓サイト](https://shinkan.chofusai.jp)を制作する際にNext.js(Pages Router)を使っており、
できればそこから大きな変更を加えたくなかったからです。やはり、ファイルベースルーティングや組み込みの画像最適化など、
絶妙にかゆいところに手の届く機能が多く、非常に便利なのは間違いありません。

<UrlCard url="https://shinkan.chofusai.jp" caption="今見るとかなり雑に感じる、懐かしい" />

ということで、特に何もなければPages Routerを使うはずでしたが、本格的に環境構築や制作の準備を始める直前にビッグニュースが飛び込んできました。

<TweetCard id="1654156302531063812" />

<TextCard>**App Router Stable?!?!?!?!?!**</TextCard>

#### App Routerのメリット

私はもともと、Pages RouterにはNext.js独特のコードがかなり多く、一般的なhtmlと同じ構造で書けるApp Routerの方が下の代へ引き継いでいくのに適していると考えていました。

{/* 下にはそれぞれの一番上の層で読み込まれるコンポーネントを載せていますが、やっぱりひと目見て自然で誰にでも分かりやすい、<span class="text-xl">**驚きが最小である**</span>のはApp Routerの方だと思うんですよね。

```tsx:_document.tsx(PagesRouter)
import { Head, Html, Main, NextScript } from 'next/document'

export default function Document() {
  return (
    <Html
      lang="ja"
      prefix="og: https://ogp.me/ns# fb: https://ogp.me/ns/fb# website: https://ogp.me/ns/website#"
    >
      <Head />
      <body>
        <Main />
        <NextScript />
      </body>
    </Html>
  )
}
```

```tsx:layout.tsx(AppRouter)
import Footer from '@/components/layout/footer'
import Favicons from '@/components/meta/favicons'
import { fontClass } from '@/lib/font'
import TwitterScript from '@/lib/twitter'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <Favicons />
      <body className={fontClass}>
        {children}
        <Footer />
        <TwitterScript />
      </body>
    </html>
  )
}
``` */}

今フロントエンド全体を見てもhtml標準、WebAPI標準に回帰していく動きがあり、App RouterはPages Routerと比較した際により将来性のある選択肢として考えられます。

あともう1つApp Routerを使いたかった大きな理由があって、**MetaDataAPI**が非常に便利なんですよね。

<UrlCard url="https://nextjs.org/docs/app/building-your-application/optimizing/metadata" />

これを使うとMetaDataをコンポーネントやページから分離した状態で扱えるので非常に見通しがよく、動的なページにおけるMetaDataの生成も関数一つで完結します。
これは本当に便利でした。

以上の理由から、安定版になったばかりではありますが、より直感的で将来的にも読みやすそうなApp Routerを採用することにしました。

#### App Routerのデメリット

とはいえ大きな変更が多いのも事実で、移行の面でデメリットが発生しました。

App Routerでは、React Server Componentと呼ばれる概念がデフォルトになっています。
よって、何も設定しなければサーバー上でレンダリングされて、ブラウザには最終的なHTMLが渡されます。

<UrlCard url="https://nextjs.org/docs/app/building-your-application/rendering/server-components" />

このため、`useEffect()`のようなブラウザ側でしか動かないコードを使う場合は明示的に分割する必要があり、
コンポーネント数が増加しやすい傾向にあります。

ただしこれは、今までの書き方では動かなくなる場合があるというだけで、それ以外の観点では大きなメリットになります。
今まですべてクライアント側で処理していたものを、機密を伴うデータフェッチや整形はサーバー側、クライアント側は表示のみというように分割することで、
より高速な表示とセキュリティの向上が期待されます。

{/* ### SCSS Modules

CSSに関しては、SCSSもしくはTailwind CSSの二択で悩んでいましたが、アニメーションや複雑なCSSプロパティの使用が想定されたのでSCSSを採用することにしました。
mixinを正しく使えばMedia Queryなども手軽に書けるので、Tailwindと比べてもそこまで苦しくない記述量で済みます。


例えば、調布祭公式Webサイトのトップページに表示されるこれは、CSS Gridの`grid-area`でレイアウトを組んでいます。
フォントサイズも`font-size: clamp(1rem, 1.25rem, 5vw);`などでかなり細かく調整しています。
これはTailwindでやるとかえって面倒になります。

![調布祭公式Webサイトのファーストビュー](https://res.cloudinary.com/sushi-chan/image/upload/v1701280468/tech/chofusai-2023-website/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2023-11-30_025304_iugfcb.png)

ただし、Tailwindが提供するユーティリティクラスは非常に良質なものが多く、その中身は大いに参考にしています。
あとデザイントークンがある程度決まっているのもかなり良く、別にTailwindがだめだという話ではないのです。
あと最近は、個人的に使い方を確立したのでむしろTailwindを使っていることのほうが多いです。

閑話休題

SCSS Moduleを使う場合のデメリットとしては、個別にSCSS Moduleファイルを増やしていくことになるのでファイル数の増加がしんどいです。
Tailwindだと、ページ内でコンポーネントを配置する際にMarginなどを直接指定できていいんですが、
SCSS Moduleではいちいち`page.module.scss`のようなファイルを増やすことになります。まあ事故を起こさずに複雑なスタイルを適用することとトレードオフ[^2]なので仕方ないですね。 */}
{/*
[^2]:
    <div>
      <span>見たな 聴いてね</span>
      <PlayerCard caption="トレードオフ / 棗いつき" url="https://www.youtube.com/watch?v=pvI0JB0y9XM" />
    </div> */}


### Markdown

なんでMarkdown...？と思われた方もいるかもしれませんが、実は今回、一部ページコンテンツと企画データの管理にMarkdownが使用されています。

例えばこのページで使われています。

<UrlCard url="https://www.chofusai.jp/news/panflet" />

このページの実態は独立したMarkdownファイルであり、それを内製ライブラリを使って

1. `/news`以下のページを生成する際に指定したディレクトリ以下のMarkdownを探索する
2. ファイル名に対応するパスを振り分ける

のような手順を踏むことで擬似的なファイルベースルーティングを実現しています。
また、この際Markdownのフロントマターに必要な情報も書くことで、効率よくページを生成できるようにしています。
企画データの管理も同様の方法で行いました。かなり楽で良かった。

ちなみにこのライブラリを試験実装したのが[旧個人サイト](https://old.sushichan.live)内のブログだったりします。[^2]

[^2]:
    <div>
      <span>急に旧個人サイトをNext.js(App Router)で作ったのは調布祭の準備の一環でした。</span>
      <UrlCard url="/blog/post/tech/build-my-website" />
    </div>

### Cloudflare

いわずと知れたつよつよCDN+αですね。私が導入を推し進めました。
CDNというのはContent Delivery Networkの略で、コンテンツをユーザーに近い場所にキャッシュして配信する仕組みのことです。

実際にした設定は多数あるため割愛しますが、複数の最適化により<span class="text-xl font-bold">75%</span>のアクセスをCDNで処理できました。
また、当然CDNからのレスポンスはVercel上のNext.jsサーバーからのものより速く、パフォーマンスの向上に繋がりました。

![Cloudflareの帯域幅分析。総トラフィック約30GBのうち22.5GBをCDN上のキャッシュでさばいている。](https://res.cloudinary.com/sushi-chan/image/upload/v1701318570/tech/chofusai-2023-website/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2023-11-30_132841_iomalu.png "オリジンへ飛ぶ帯域幅を22.5GB削減できました。")

また、過去の調布祭ページなどを記録用として静的ホスティングするのにCloudflare Pagesを使用しています。第73回サイトもいずれこちらに移行する予定です。

### Vercel

まあNext.jsを使うならVercelでしょう。特に深い意味はないです。

<span class="text-xl font-bold">...というのは嘘で、</span>実は当初はCloudflare Pagesにデプロイする予定でした。
というのもVercelは無料枠での帯域幅に月間100GBという制限があるのに対し、Cloudflare Pagesは事実上無制限だったからです。

ただ、どうしても当時Cloudflare Pagesのようなエッジ上でNext.jsの画像最適化をコストを抑えながら動かす方法がなく、
調布祭サイトで最も帯域を抑えやすいのは画像などの静的アセットの最適化であると判断したので、Vercelに変更しました。[^3]

その分最適化に力を入れ、結果的には無料枠のわずか7%の帯域幅に抑えることができました。

[^3]:
    <div>
      <span>近日中にCloudflareの画像最適化に変更が入るので、それが完了するとかなり現実的に使えるようになります。</span>
      <UrlCard caption="この前の大規模障害が原因で少し遅れているらしい" url="https://blog.cloudflare.com/merging-images-and-image-resizing/" />
    </div>

## 特に意識したこと

調布祭サイトは、当然ながら開催期間中はアクセスが集中します。今年度は本格的にコロナ禍前の姿に戻すということで入場予約も不要になり、アクセス数の予測ができない状態でした。
さらに、もともと学内の電波状況がいいとは言えない状態なため、通信速度がある程度落ちた状態でも高速に読み込める必要がありました。

このため、可能な限りユーザーに近いCDNまででリクエストを完結させて、また配信されるコンテンツのサイズを小さくする工夫をしました。

これにおいて最も重要なのが画像の最適化です。
Next.jsでは`<Image />`コンポーネントに画像サイズを事前に指定することで、画面幅に合わせて最適な画像を配信してくれます。

<UrlCard url="https://nextjs.org/docs/app/api-reference/components/image" />

しかし、例えば企画情報ページなどでは、団体ごとに提出された画像のサイズやアスペクト比などが異なるため、通常のサイズ指定では対応できません。
そこで、`fill`と`sizes`を組み合わせて実際の画面専有領域ベースでの最適化に切り替えました。
途中までこれを忘れていたのですが、やる前とやる後で明らかに使用される帯域幅に変化があったので、忘れずやってよかったです。

また、Google AnalyticsはCloudflare Zarazを経由して使用しました。
Cloudflare Zarazは、CloudflareのCDNを通過する際にHTMLを書き換えて追加コードを挿入できる機能で、
これを用いてCDN上でGoogle Analyticsのコードを追加しています。
こうすると、余分なサードパーティへのリクエストがなくなるので、パフォーマンスの向上に繋がります。
まあこれは私が使いたかっただけなのですが...

<UrlCard url="https://developers.cloudflare.com/zaraz/" />

他にも`content-visibility`を用いた遅延レンダリングや一部アセットのprefetch、
重たいコンポーネントの動的読み込みやスケルトン表示を行い、非常に高速な表示が実現できました。
表示の速さについての声も少し耳にしたのでちょっと嬉しかったです。

## うまくできなかったこと

当初はデザインをFigmaなどで組み立ててから実装する予定でした。
しかし、肝心のWebデザイン経験のある人間がほとんどいなかったためデザインが決まらないまま時間が経ち、
ぎりぎりになってからその場の勢いで実装するという形になってしまいました。
このため、かなり簡素なデザインになってしまい、他の大学祭のサイトと比較してもあまりお祭り感のないものになりました。
これは本当に悔しくて、お褒めの言葉を頂いていても「もっと華やかなデザインにできたはずなのに」という気持ちがずっとあります。

また、7割以上の人員が2023年3月以降に初めてHTMLを触った、という初心者だったにも関わらず、
十分な講習時間を取れないまま実装を進めてしまいました。
このため、予想以上の手戻りや遅れが発生し、調布祭2日目の昼頃にようやく実装が完了するという結果になってしまいました。

<TweetCard id="1728129232050745516" caption="限界作業をやめよう！その1" />

<TweetCard id="1728214512522949091" caption="限界作業をやめよう！その2" />

これから、委員会内ではこれらを来年度どのように改善するかを考えていきます。

## おわりに

長くなってしまいましたが、第73回調布祭Webサイトの裏側を話せる範囲で書いてみました。
この制作は、ほとんどの人員がWeb未経験の状態から数ヶ月で比較的大きなサイトを作るという、私にとって、そして調布祭実行委員会にとって大きな挑戦でした。
私自身この制作を通して学んだことが非常に多く、春先は新歓サイトの作成で手一杯だったのが今では個人でもWeb制作を行えるようになりました。

たくさんの方にご迷惑をおかけし、また、たくさんの方にご協力いただきました。
最終的に至らぬ点はあったとはいえ、多くの方に好評をいただけたことは本当に嬉しかったです。
記事内では書ききれなかった調布祭実行委員会編集局のメンバーの偉業、および委員会員やOBの方々、また協力してくださったすべての方々に感謝申し上げます。

<span class="text-xl font-bold">さて、</span>
明日の記事はローネさんの「入力デバイスとして1年間板タブを使い続けた話」です。
マウスの代わりに板タブ使ってるってことだとしたら怖すぎる、楽しみですね。

それではまたどこかで。
